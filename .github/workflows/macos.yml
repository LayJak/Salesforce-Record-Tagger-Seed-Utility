# .github/workflows/macos.yml
name: Build macOS DMG and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Use the latest stable versions of all libraries
          pip install PySide6 pandas Pillow numpy pyinstaller

      - name: Create .icns from .png (Robust Method)
        run: |
          python -c "
          from PIL import Image
          import os
          source_image = 'icon.png'
          iconset_dir = 'icon.iconset'
          os.makedirs(iconset_dir, exist_ok=True)
          img = Image.open(source_image)
          sizes = [16, 32, 128, 256, 512]
          for size in sizes:
              img.resize((size, size), Image.Resampling.LANCZOS).save(os.path.join(iconset_dir, f'icon_{size}x{size}.png'))
              img.resize((size * 2, size * 2), Image.Resampling.LANCZOS).save(os.path.join(iconset_dir, f'icon_{size}x{size}@2x.png'))
          "
          iconutil -c icns icon.iconset -o app_icon.icns

      - name: Build macOS App with PyInstaller (Simplified Command)
        run: |
          pyinstaller Tagger.py \
            --name "SF Tagger" \
            --onefile \
            --windowed \
            --icon="app_icon.icns" \
            --collect-data pandas \
            --hidden-import=numpy

      - name: Create DMG
        run: |
          brew install create-dmg
          mkdir -p dmg_assets
          mv "dist/SF Tagger" dmg_assets/
          create-dmg \
            --volname "SF Tagger Installer" \
            --window-pos 200 120 --window-size 600 380 \
            --icon-size 100 \
            --icon "SF Tagger" 150 190 \
            --app-drop-link 450 190 \
            "SF_Tagger_macOS.dmg" \
            "dmg_assets/"

      - name: Upload DMG as an Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SF_Tagger_macOS_DMG
          path: SF_Tagger_macOS.dmg

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SF_Tagger_macOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
